
<div>
    <table style="width: 100%;">
        <thead>
            <tr>
                <th style="width: 180px;">名称</th><th>URL</th><th style="width: 1px;"><input type="button" id="save" value="保存" style="display: none;"></th>
            </tr>
            <tr id="form">
                <th><input name="name" type="text"></th>
                <th class="main_field"><input name="url" type="url"></th>
                <th><input type="button" id="add" class="add" value="&plus;"></th>
            </tr>
        </thead>
        <tbody id="sites">
            <!-- {{#sites}} -->
            <tr id="{{id}}">
                <td><input name="name" type="text" value="{{name}}" required readonly></td>
                <td class="main_field"><input name="url" type="url" value="{{url}}" required readonly></td>
                <td><input type="button" class="delete" class="delete" value="&times;"><span class="move-handler">&#8645;</span></td>
            </tr>
            <!-- {{/sites}} -->
        </tbody>
    </table>
</div>
<script>
    (function(){
        console.log('sites.html');
        var options = {
            idField:'url',

        };
        var url2id = function(url) {
            return 'site-' + btoa(encodeURIComponent(url)).replace(/\=/g, '').replace(/\//, '_').replace(/\+/, '-');
        };
        var id2url = function(id) {
            return decodeURIComponent(atob(id.substring(5).replace(/\-/g, '+').replace(/\_/, '/')));
        };
        var urlDuplicated = function(id, ignore) {
            var existed = $('#'+id).not(ignore);
            if (existed.length > 0) {
                var e = existed.find('[name="'+options.idField+'"]').get(0);
                e.classList.add('blink');
                setTimeout(()=>{e.classList.remove('blink');}, 1250);
                return true;
            }
        };
        var inputSelector = 'input[type="text"],input[type="url"]';
        var edit = function(target) {
            var tr = $(target).closest('tr');
            tr.addClass('editting');
            tr.find('input,select').not(target).attr('disabled', true);
            target.readOnly = undefined;
            target.focus();
        };
        $('#sites').on('click', inputSelector, e => {
            var target = e.target;
            if (target.disabled || !target.readOnly) return;
            edit(target);
        }).on('mousedown', 'td', e => {
            var target = e.target;
            if (target.tagName != 'INPUT' || target.disabled) {
                $('#sites input:focus').blur();
            }
        }).on('change', inputSelector, e => {
            var target = e.target;
            var tr = $(target).closest('tr');
            var row = tr.find('input,select');
            var validate = true;
            row.each((i,e)=>{
                if (!e.checkValidity()) {
                    validate = false;
                    return false;
                }
            });
            var oldId = tr.get(0).id;
            if (validate && target.name == options.idField) {
                var id = url2id(target.value);
                if (urlDuplicated(id, tr)) {
                    validate = false;
                } else {
                    tr.get(0).id = id;
                }
            }
            if (validate) {
                target.classList.remove('invalid');
                var oldUrl = id2url(oldId);
                var site = row.form();
                updateSite(oldUrl, site);
            } else {
                target.classList.add('invalid');
            }
        }).on('blur', inputSelector, e => {
            var target = e.target;
            if (target.classList.contains('invalid')) {
                setTimeout(() => {
                    target.focus();
                }, 0);
                return;
            }
            var tr = $(target).closest('tr');
            tr.removeClass('editting');
            target.readOnly = true;
            tr.find('input,select').removeAttr('disabled');
        }).sortable({
            axis: 'y',
            cancel: 'tr.editting *',
            distance: 10,
            stop: function(e,u) {
                var urls = [];
                $('#sites tr').each((i,e)=>{
                    urls.push(id2url(e.id));
                });
                sortSite(urls);
            }
        });

        $('#form').on('blur', inputSelector, e => {
            e.target.classList.remove('invalid');
            e.target.setCustomValidity('');
            e.target.checkValidity();
        });
        $('#sites').on('click', '.delete', e => {
            var target = e.target;
            var tr = $(target).closest('tr');
            var url = id2url(tr.get(0).id);
            tr.remove();
            removeSite(url);
        });
        getConfig(
            config => {
                var siteTemplate = $('#sites').html();
                config.id = function(){return url2id(this[options.idField]);};
                var list = Mustache.render(siteTemplate, config);
                $('#sites').html(list);
                $('#add').on('click', e => {
                    var target = e.target;
                    var row = $(target).closest('tr').find('input,select').not(target);
                    var validate = true;
                    row.each((i,e)=>{
                        e.setCustomValidity('');
                        if (e.value === '') {
                            e.setCustomValidity('请填写此字段。');
                        }
                        if (!e.reportValidity()) {
                            e.classList.add('invalid');
                            e.focus();
                            validate = false;
                            return false;
                        } else {
                            e.classList.remove('invalid');
                        }
                    });
                    if (validate) {
                        var site = row.form();
                        var id = url2id(site[options.idField]);
                        if (urlDuplicated(id)) {
                            var e = row.filter('[name="' + options.idField + '"]').get(0);
                            e.classList.add('invalid');
                            e.setCustomValidity('已存在');
                            e.focus();
                            e.reportValidity();
                        } else {
                            addSite(site, () => {
                                row.val('');
                                $('#sites').prepend(Mustache.render(siteTemplate, {sites:[$.extend(site, {id})]}));
                            });
                        }
                    }
                });
                $('#save').on('click', e => {
                    var sites = $('#sites tr').map((i,e)=>$(e).find('input,select').form()).get();
                    rpc({
                        url: 'api/config',
                        method: 'post',
                        data: {sites},
                        error: e => {
                            console.error('update sites', e);
                        }
                    });
                });
            }
        );
    })();
</script>